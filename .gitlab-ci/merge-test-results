#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright 2018  Ternaris.
# SPDX-License-Identifier: Apache-2.0

"""Merge junit test result files as generated by colcon.

colcon generates individual junit test result files, gitlab expects a
single file or a list of a priori known files. This command parses
individual files and generates one file containing results for all
test suites.

Usage:
  colcon test-result --all | grep xml |cut -d":" -f1 | \
      xargs .gitlab-ci/merge-test-results test-results.xml

If the output file exists already it will be extended.
"""

import sys
import xml.etree.ElementTree as ET


def cli(output, *reports):
    """Merge junit reports into one output report."""
    try:
        tree = ET.parse(output)
    except FileNotFoundError:
        tree = ET.ElementTree(ET.Element('testsuites'))

    testsuites = tree.getroot()
    assert testsuites.tag == 'testsuites'

    for path in reports:
        root = ET.parse(path).getroot()
        if root.tag == 'testsuite':
            testsuites.append(root)
        elif root.tag == 'testsuites':
            for suite in root:
                testsuites.append(suite)
        print('Merged:', path)

    tree.write(output)


if __name__ == '__main__':
    cli(*sys.argv[1:])
